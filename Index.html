<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fintech Portfolio Pulse</title>
    <style>
        /* --- CSS VARIABLES for Dark Theme --- */
        :root {
            --bg-dark: #1e2738;
            --card-bg: #2a3447;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --shadow-dark: rgba(0, 0, 0, 0.6);
            --font-family: 'Inter', sans-serif;
        }

        /* --- Base & Typography --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        p {
            color: var(--text-muted);
        }

        /* --- Utility Classes --- */
        .rounded-xl { border-radius: 12px; }
        .rounded-2xl { border-radius: 16px; }
        .shadow-lg { box-shadow: 0 10px 15px -3px var(--shadow-dark), 0 4px 6px -2px var(--shadow-dark); }
        .text-center { text-align: center; }

        /* --- Dashboard Layout & Cards --- */
        .panel {
            background-color: var(--card-bg);
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 20px;
            border: 1px solid #3e4b60;
            transition: all 0.3s ease;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            padding: 20px;
            border-radius: 16px;
            border-top: 5px solid;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px -5px var(--shadow-dark);
        }

        .metric-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .metric-card-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-top: 5px;
            display: block;
        }

        .card-investment { border-top-color: var(--accent-blue); }
        .card-value { border-top-color: var(--accent-cyan); }
        .card-volatility { border-top-color: #fcd34d; } /* Yellow */
        .card-return-up { border-top-color: var(--accent-green); }
        .card-return-down { border-top-color: var(--accent-red); }
        .text-green { color: var(--accent-green); }
        .text-red { color: var(--accent-red); }

        /* --- Control Panel --- */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        @media (min-width: 768px) {
            .control-panel {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        /* --- Button Styling --- */
        .btn-primary {
            background: linear-gradient(90deg, #10b981, #06b6d4);
            color: white;
            font-weight: bold;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
            height: 50px; /* fixed height for alignment */
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.6);
        }

        .btn-primary:disabled {
            background: #5c6c82;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* --- Slider Styling --- */
        .slider-container {
            flex-grow: 1;
        }

        .slider-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #475569;
            border-radius: 4px;
            outline: none;
            transition: opacity 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-cyan);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(6, 182, 212, 0.7);
            transition: background 0.2s, box-shadow 0.2s;
        }

        .risk-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* --- SVG Chart Container --- */
        .chart-container {
            overflow-x: auto;
            background-color: #1a202c; /* Darker than card-bg for contrast */
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #334155;
        }

        #performance-chart {
            display: block;
            min-width: 100%;
        }

        .status-message {
            background-color: #334155;
            color: var(--text-light);
            padding: 12px;
            margin-bottom: 24px;
            border-radius: 8px;
            border: 1px solid #475569;
            font-weight: 500;
        }

        /* --- Holdings Table --- */
        .holdings-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .holdings-table th, .holdings-table td {
            padding: 15px;
            text-align: left;
        }

        .holdings-table th {
            color: var(--accent-cyan);
            text-transform: uppercase;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .holdings-table tr:not(:first-child) {
            background-color: #242c3b;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .holdings-table tr:not(:first-child):hover {
            background-color: #334155;
        }

        .holdings-table td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .holdings-table td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        .holdings-table td { font-weight: 500; }
        .text-ticker { font-weight: 700; color: var(--accent-green); }

        /* --- Loading Spinner CSS (Optional but good UX) --- */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        .loading-content {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>Fintech Portfolio Pulse</h1>
            <p>Interactive simulator for portfolio performance and risk modeling over 252 trading days.</p>
        </header>

        <!-- Status Message -->
        <div id="status-message" class="status-message rounded-xl text-center">
            Define your risk tolerance and click 'Run Analysis' to see the simulation.
        </div>

        <!-- Control Panel -->
        <div class="panel rounded-2xl shadow-lg">
            <h2 style="margin-top: 0;">Risk Profile & Simulation Control</h2>
            <div class="control-panel">
                <!-- Slider -->
                <div class="slider-container">
                    <label id="risk-label" class="slider-label" for="risk-slider">
                        Volatility Factor: Balanced (x1.0)
                    </label>
                    <input type="range" id="risk-slider" min="0.5" max="1.5" step="0.1" value="1.0">
                    <div class="risk-labels">
                        <span>Low Risk (0.5)</span>
                        <span>High Risk (1.5)</span>
                    </div>
                </div>

                <!-- Button -->
                <button id="run-button" class="btn-primary">
                    Run Analysis
                </button>
            </div>
        </div>

        <!-- Metric Cards (Hidden until run) -->
        <div id="metrics-section" class="metrics-grid" style="display: none;">
            <div class="metric-card card-investment">
                <span class="metric-card-title">Initial Investment</span>
                <strong id="metric-investment" class="metric-card-value">--</strong>
            </div>
            <div class="metric-card card-value">
                <span class="metric-card-title">Final Portfolio Value</span>
                <strong id="metric-final-value" class="metric-card-value">--</strong>
            </div>
            <div class="metric-card" id="card-return">
                <span class="metric-card-title">Total Return (YTD)</span>
                <strong id="metric-return" class="metric-card-value">--</strong>
            </div>
            <div class="metric-card card-volatility">
                <span class="metric-card-title">Annualized Volatility</span>
                <strong id="metric-volatility" class="metric-card-value">--</strong>
            </div>
        </div>

        <!-- Chart Visualization -->
        <div id="chart-section" class="panel rounded-2xl shadow-lg" style="display: none;">
            <h2 id="chart-title" style="margin-top: 0; display: flex; align-items: center;">
                Portfolio Performance <span id="performance-tag" style="margin-left: 1rem; font-size: 0.9rem; padding: 4px 10px; border-radius: 6px; font-weight: bold;"></span>
            </h2>
            <div class="chart-container">
                <svg id="performance-chart" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>

        <!-- Holdings Summary -->
        <div id="holdings-section" class="panel rounded-2xl shadow-lg" style="display: none;">
            <h2>Core Holdings</h2>
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Shares</th>
                        <th>Starting Price</th>
                        <th>Simulated End Price</th>
                    </tr>
                </thead>
                <tbody id="holdings-body">
                    <!-- Data injected by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Configuration Constants ---
        const START_PRICE_BASES = { 'AAPL': 150.0, 'MSFT': 280.0, 'GOOG': 95.0, 'TSLA': 200.0 };
        const PORTFOLIO_HOLDINGS = { 'AAPL': 100, 'MSFT': 50, 'GOOG': 20, 'TSLA': 30 };
        const INITIAL_CASH = 10000.0;
        const SIMULATION_DAYS = 252;
        const INITIAL_MESSAGE = "Define your risk tolerance and click 'Run Analysis' to see the simulation.";

        // --- DOM Elements ---
        const statusMessageEl = document.getElementById('status-message');
        const runButtonEl = document.getElementById('run-button');
        const riskSliderEl = document.getElementById('risk-slider');
        const riskLabelEl = document.getElementById('risk-label');
        const metricsSectionEl = document.getElementById('metrics-section');
        const chartSectionEl = document.getElementById('chart-section');
        const holdingsSectionEl = document.getElementById('holdings-section');
        const holdingsBodyEl = document.getElementById('holdings-body');
        const performanceTagEl = document.getElementById('performance-tag');

        // --- Utility Functions ---

        const FORMATTER = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
        const DECIMAL_FORMATTER = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const PERCENT_FORMATTER = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 });

        /**
         * Generates a random number following a normal distribution (Box-Muller).
         */
        const boxMullerTransform = () => {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            const num = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return num;
        };

        /**
         * Simulates daily price data using Geometric Brownian Motion.
         * @param {number} volatilityFactor - Multiplier for standard deviation.
         * @returns {Array<Object>} Daily price data.
         */
        const simulatePrices = (volatilityFactor = 1.0) => {
            const priceData = [];
            const mu = 0.0001;
            const sigma = 0.015 * volatilityFactor; // Apply user risk factor

            let currentPrices = { ...START_PRICE_BASES };

            for (let i = 0; i < SIMULATION_DAYS; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);

                const dailyData = {
                    date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    dayIndex: i,
                    ...currentPrices
                };
                priceData.push(dailyData);

                let nextPrices = {};
                for (const [ticker, price] of Object.entries(currentPrices)) {
                    const z = boxMullerTransform();
                    const drift = mu - 0.5 * sigma * sigma;
                    const shock = sigma * z;
                    const dailyReturnFactor = Math.exp(drift + shock);
                    nextPrices[ticker] = price * dailyReturnFactor;
                }
                currentPrices = nextPrices;
            }
            return priceData;
        };

        /**
         * Calculates daily portfolio value and key financial metrics.
         * @param {Array<Object>} priceData - Simulated price data.
         * @returns {Object} Analysis results.
         */
        const analyzePortfolio = (priceData) => {
            let dailyAnalysis = [];
            let dailyReturns = [];

            const initialHoldingsValue = Object.entries(PORTFOLIO_HOLDINGS).reduce((sum, [ticker, shares]) => {
                return sum + shares * START_PRICE_BASES[ticker];
            }, 0);
            const totalInvestment = initialHoldingsValue + INITIAL_CASH;

            let previousPortfolioValue = totalInvestment;

            for (const day of priceData) {
                const totalHoldingsValue = Object.entries(PORTFOLIO_HOLDINGS).reduce((sum, [ticker, shares]) => {
                    return sum + shares * day[ticker];
                }, 0);

                const currentPortfolioValue = totalHoldingsValue + INITIAL_CASH;
                const dailyReturn = (currentPortfolioValue - previousPortfolioValue) / previousPortfolioValue;

                dailyAnalysis.push({
                    date: day.date,
                    portfolioValue: currentPortfolioValue,
                    endPrices: day,
                });

                if (!isNaN(dailyReturn)) {
                    dailyReturns.push(dailyReturn);
                }

                previousPortfolioValue = currentPortfolioValue;
            }

            // --- Metrics Calculation ---
            const finalValue = dailyAnalysis[dailyAnalysis.length - 1]?.portfolioValue || totalInvestment;
            const totalReturn = (finalValue - totalInvestment) / totalInvestment;

            // Volatility (Risk)
            const avgReturn = dailyReturns.reduce((sum, r) => sum + r, 0) / dailyReturns.length;
            const variance = dailyReturns.reduce((sum, r) => sum + (r - avgReturn) ** 2, 0) / (dailyReturns.length - 1 || 1);
            const dailyStdDev = Math.sqrt(variance);
            const annualizedVolatility = dailyStdDev * Math.sqrt(SIMULATION_DAYS);

            return {
                dailyData: dailyAnalysis,
                metrics: {
                    totalInvestment,
                    finalPortfolioValue: finalValue,
                    totalReturn,
                    annualizedVolatility,
                }
            };
        };

        /**
         * Updates the metric cards in the DOM.
         * @param {Object} metrics - Formatted metrics object.
         */
        const updateMetricsDOM = (metrics) => {
            const isProfit = metrics.totalReturn > 0;
            const returnCard = document.getElementById('card-return');

            // Set values
            document.getElementById('metric-investment').textContent = FORMATTER.format(metrics.totalInvestment);
            document.getElementById('metric-final-value').textContent = FORMATTER.format(metrics.finalPortfolioValue);
            document.getElementById('metric-return').textContent = PERCENT_FORMATTER.format(metrics.totalReturn);
            document.getElementById('metric-volatility').textContent = PERCENT_FORMATTER.format(metrics.annualizedVolatility);

            // Apply color coding for return
            returnCard.classList.remove('card-return-up', 'card-return-down');
            returnCard.classList.add(isProfit ? 'card-return-up' : 'card-return-down');
            document.getElementById('metric-return').style.color = isProfit ? 'var(--accent-green)' : 'var(--accent-red)';
        };

        /**
         * Renders the Holdings Summary table.
         * @param {Array<Object>} analysisData - The final day's analysis data.
         */
        const renderHoldingsSummary = (analysisData) => {
            holdingsBodyEl.innerHTML = '';
            if (analysisData.length === 0) return;

            const finalDayData = analysisData[analysisData.length - 1].endPrices;

            for (const [ticker, shares] of Object.entries(PORTFOLIO_HOLDINGS)) {
                const startPrice = START_PRICE_BASES[ticker];
                const endPrice = finalDayData[ticker];

                const row = holdingsBodyEl.insertRow();
                row.innerHTML = `
                    <td class="text-ticker">${ticker}</td>
                    <td>${shares.toLocaleString()}</td>
                    <td>${DECIMAL_FORMATTER.format(startPrice)}</td>
                    <td>${DECIMAL_FORMATTER.format(endPrice)}</td>
                `;
            }
        };


        // --- SVG Chart Rendering ---

        const renderChart = (data) => {
            const svg = document.getElementById('performance-chart');
            svg.innerHTML = ''; // Clear previous chart content

            if (!data || data.length < 2) return;

            const SVG_WIDTH = 800;
            const SVG_HEIGHT = 300;
            const PADDING = 40;
            const CHART_WIDTH = SVG_WIDTH - 2 * PADDING;
            const CHART_HEIGHT = SVG_HEIGHT - 2 * PADDING;

            const values = data.map(d => d.portfolioValue);
            const initialValue = data[0].portfolioValue;
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const isProfitable = data[data.length - 1].portfolioValue >= initialValue;
            const chartColor = isProfitable ? 'var(--accent-green)' : 'var(--accent-red)';

            // Y-Axis scaling with 10% buffer
            const range = maxVal - minVal;
            const yMin = minVal - range * 0.1;
            const yMax = maxVal + range * 0.1;
            const yRange = yMax - yMin;

            // Mapping functions
            const getX = (index) => PADDING + (index / (data.length - 1)) * CHART_WIDTH;
            const getY = (value) => PADDING + CHART_HEIGHT - ((value - yMin) / yRange) * CHART_HEIGHT;

            // Prepare points string for Polyline
            // Using a filter to sample points for cleaner SVG path rendering
            const points = data.filter((_, i) => i % 5 === 0 || i === 0 || i === data.length - 1).map((d, i) =>
                `${getX(d.dayIndex || i * 5)},${getY(d.portfolioValue)}`
            ).join(' ');


            // 1. Chart Background (Inner rectangle)
            const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bgRect.setAttribute('x', PADDING);
            bgRect.setAttribute('y', PADDING);
            bgRect.setAttribute('width', CHART_WIDTH);
            bgRect.setAttribute('height', CHART_HEIGHT);
            bgRect.setAttribute('fill', '#1e2738');
            bgRect.setAttribute('rx', '8');
            svg.appendChild(bgRect);

            // 2. Define Gradient for Area Fill
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', 'chartGradient');
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '0%');
            gradient.setAttribute('y2', '100%');

            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('style', `stop-color: ${chartColor}; stop-opacity: 0.3;`);

            const stop2 = document.createElementNS('http://www.w3.0rg/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('style', `stop-color: ${chartColor}; stop-opacity: 0;`);

            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            defs.appendChild(gradient);
            svg.appendChild(defs);

            // 3. Y-Axis Grid Lines and Labels
            const yTicks = [yMin, (minVal + maxVal) / 2, yMax].map(v => parseFloat(v.toFixed(0)));
            const yLabels = yTicks.map(v => FORMATTER.format(v));

            yTicks.forEach((tick, i) => {
                const yPos = getY(tick);
                // Grid Line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', PADDING);
                line.setAttribute('y1', yPos);
                line.setAttribute('x2', SVG_WIDTH - PADDING);
                line.setAttribute('y2', yPos);
                line.setAttribute('stroke', '#334155');
                line.setAttribute('stroke-dasharray', '4 4');
                svg.appendChild(line);

                // Label
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', PADDING - 8);
                text.setAttribute('y', yPos + 3);
                text.setAttribute('text-anchor', 'end');
                text.setAttribute('font-size', '10');
                text.setAttribute('fill', 'var(--text-muted)');
                text.textContent = yLabels[i];
                svg.appendChild(text);
            });

            // 4. Area Under the Curve (Path for gradient fill)
            const areaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M ${getX(0)} ${getY(yMin)} L ${points.split(' ').join(' L ')} L ${getX(data.length - 1)} ${getY(yMin)} Z`;
            areaPath.setAttribute('d', d);
            areaPath.setAttribute('fill', 'url(#chartGradient)');
            areaPath.setAttribute('stroke', 'none');
            svg.appendChild(areaPath);

            // 5. The Main Line (Polyline)
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', chartColor);
            polyline.setAttribute('stroke-width', '3');
            polyline.setAttribute('points', points);
            polyline.setAttribute('stroke-linejoin', 'round');
            polyline.setAttribute('stroke-linecap', 'round');
            polyline.setAttribute('style', `filter: drop-shadow(0 0 5px ${chartColor}50);`); // subtle glow
            svg.appendChild(polyline);

            // 6. X-Axis Labels (Start, Middle, End)
            const xTicksIndices = [0, Math.floor(data.length / 2), data.length - 1];
            const xLabels = xTicksIndices.map(i => data[i].date);

            xTicksIndices.forEach((i, idx) => {
                const xPos = getX(i);
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', xPos);
                text.setAttribute('y', SVG_HEIGHT - PADDING / 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '10');
                text.setAttribute('fill', 'var(--text-muted)');
                text.textContent = xLabels[idx];
                svg.appendChild(text);
            });

            // 7. Final Value Marker
            const finalDataPoint = data[data.length - 1];
            const finalX = getX(data.length - 1);
            const finalY = getY(finalDataPoint.portfolioValue);

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', finalX);
            circle.setAttribute('cy', finalY);
            circle.setAttribute('r', '6');
            circle.setAttribute('fill', chartColor);
            circle.setAttribute('stroke', 'var(--bg-dark)');
            circle.setAttribute('stroke-width', '2');
            svg.appendChild(circle);

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', finalX + 12);
            text.setAttribute('y', finalY + 4);
            text.setAttribute('text-anchor', 'start');
            text.setAttribute('font-size', '12');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', chartColor);
            text.textContent = FORMATTER.format(finalDataPoint.portfolioValue);
            svg.appendChild(text);

            // Update performance tag
            performanceTagEl.textContent = isProfitable ? 'GROWTH' : 'LOSS';
            performanceTagEl.style.backgroundColor = isProfitable ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            performanceTagEl.style.color = chartColor;
        };

        // --- Main Execution Logic ---

        const getRiskLabel = (factor) => {
            if (factor <= 0.6) return 'Low Risk';
            if (factor <= 1.1) return 'Balanced';
            return 'High Risk';
        };

        const updateRiskLabel = () => {
            const factor = parseFloat(riskSliderEl.value);
            riskLabelEl.textContent = `Volatility Factor: ${getRiskLabel(factor)} (x${factor.toFixed(1)})`;
        };

        const runAnalysis = () => {
            const volatilityFactor = parseFloat(riskSliderEl.value);

            // Disable button and start loading state
            runButtonEl.disabled = true;
            runButtonEl.innerHTML = `<span class="loading-content"><span class="loading-spinner"></span> Running...</span>`;
            statusMessageEl.textContent = "Running sophisticated simulation with defined volatility...";

            // Use a slight delay to simulate processing and allow UI to update
            setTimeout(() => {
                try {
                    const priceData = simulatePrices(volatilityFactor);
                    const analysisResult = analyzePortfolio(priceData);

                    // Update DOM sections
                    updateMetricsDOM(analysisResult.metrics);
                    renderChart(analysisResult.dailyData);
                    renderHoldingsSummary(analysisResult.dailyData);

                    // Show sections
                    metricsSectionEl.style.display = 'grid';
                    chartSectionEl.style.display = 'block';
                    holdingsSectionEl.style.display = 'block';

                    statusMessageEl.textContent = "Analysis Complete. Portfolio performance visualized.";
                } catch (error) {
                    console.error("Simulation failed:", error);
                    statusMessageEl.textContent = "An error occurred during simulation. Check the console for details.";
                } finally {
                    // Restore button state
                    runButtonEl.disabled = false;
                    runButtonEl.innerHTML = `Run Analysis`;
                }
            }, 800); // Simulated delay
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup for the slider label
            updateRiskLabel();

            // Hook up controls
            riskSliderEl.addEventListener('input', updateRiskLabel);
            runButtonEl.addEventListener('click', runAnalysis);
        });

    </script>
</body>
      </html>
